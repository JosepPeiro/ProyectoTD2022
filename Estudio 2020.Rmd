---
title: "Estudio datos 2020"
author: "Gema Bravo, Josep Peiro, Candela Santandreu, Mireia Risueño & Javier Montaner"
date: "16/4/2022"
output: html_document
---

```{r setup, cache = F, echo = F, message = F, warning = F, tidy = F}

# CONFIGURACIÓN GENERAL
library(knitr)
options(width = 100)

# Opciones generales de los chucks. Se utilizarán salvo cambios en el chunk
opts_chunk$set(echo=T, message = F, error = F, warning = F, comment = NA, fig.align = 'center', dpi = 200, tidy = F, cache.path = '.cache/', fig.path = './figura/')

# Opciones generales de dígitos cuando se incluyen tablas
#options(xtable.type = 'html')
knit_hooks$set(inline = function(x) {
  
  if(is.numeric(x)) {
    round(x, getOption('digits'))
  } else {
    paste(as.character(x), collapse = ', ')
  }
})
#knit_hooks$set(plot = knitr:::hook_plot_html)
```

```{r, echo=F}
# Especificamos las librerías necesarias en esta lista

packages = c("readr","dplyr","lubridate", "tidyr","tibble", "ggplot2", "purrr", "PerformanceAnalytics", "grid")

#use this function to check if each package is on the local machine
#if a package is installed, it will be loaded
#if any are not, the missing package(s) will be installed and loaded
package.check <- lapply(packages, FUN = function(x) {
  if (!require(x, character.only = TRUE)) {
    install.packages(x, dependencies = TRUE,repos='http://cran.rediris.es')
  }
  library(x, character.only = TRUE)
})

#verify they are loaded
#search()

```

Este sera el Rmd donde trabajaremos con los datos de 2020

## Carga de datos
```{r}
load("./dataframes/datos_2020.Rdata")
datos = datos_2020
```

## Estudio estadistico
```{r}
estadisticos = function(x){
  minimo = round(min(x, na.rm=T),2)
  percentil_25 = round(quantile(x, 0.25, na.rm=T),2)
  mediana = round(median(x, na.rm=T),2)
  media = round(mean(x, na.rm=T),2)
  desviacion_tipica = round(sd(x, na.rm=T),2)
  percentil_75 = round(quantile(x, 0.75, na.rm=T),2)
  maximo = round(max(x, na.rm=T),2)
  vector = c(minimo, percentil_25, mediana, media, desviacion_tipica, percentil_75, maximo)
  names(vector)=NULL
  return (vector)
}
```

```{r}
tabla_estadisticos = data.frame()

for (a in datos[,2:6]){
  b = estadisticos(a)
  tabla_estadisticos=rbind(tabla_estadisticos, b)
}

colnames(tabla_estadisticos) = c("minimo", "percentil_25", "mediana", "media", "desviacion_tipica", "percentil_75", "maximo")
rownames(tabla_estadisticos)=colnames(datos[,2:6])
tabla_estadisticos
```

## Estudio outliers
```{r}
outliers = function(x, method="3sigma"){
  media = mean(x)
  sigma = sd(x)
  mediana = median(x)
  q1 = quantile(x, 0.25)
  q3 = quantile(x, 0.75)
  iqr = IQR(x)
  if (method == "3sigma"){
    lowLim = media-3*sigma
    upLim = media+3*sigma
  } 
  if(method=="percentil"){
    lowLim=quantile(x, 0.05)
    upLim=quantile(x, 0.95)
  }
  if(method=="boxplot"){
    lowLim=q1-1.5*iqr
    upLim=q3+1.5*iqr
  }
  if (method == "hampel"){
    medabdev = mad(x)
    lowLim=mediana-3*medabdev
    upLim=mediana+3*medabdev
  }
  nOut = length(which(x<lowLim|x>upLim))
  minIn = min(x[which(x>lowLim)])
  maxOut = max(x[which(x<lowLim)])
  maxIn = max(x[which(x<upLim)])
  minOut = min(x[which(x>upLim)])
  resultado = cbind(nOut, lowLim, upLim, maxOut, minIn, maxIn, minOut)
  rownames(resultado)=NULL
  return (resultado)
}
```


```{r}
out_3sigma = data.frame()
for (c in datos[,2:6]){
  resultado = outliers(c)
  out_3sigma=rbind(out_3sigma, resultado)
}
out_3sigma

out_percentil = data.frame()
for (c in datos[,2:6]){
  resultado = outliers(c, "percentil")
  out_percentil=rbind(out_percentil, resultado)
}
out_percentil

out_boxplot = data.frame()
for (c in datos[,2:6]){
  resultado = outliers(c, "boxplot")
  out_boxplot=rbind(out_boxplot, resultado)
}
out_boxplot

out_hampel = data.frame()
for (c in datos[,2:6]){
  resultado = outliers(c, "hampel")
  out_hampel=rbind(out_hampel, resultado)
}
out_hampel
```

## Estudio correlación y covarianza

```{r}

cat('Covarianza Pearson\n')
cov(select(datos,starts_with("noise")))
cat('\nCorrelación Pearson\n')
cor(select(datos,starts_with("noise")))
cat('\nCovarianza Spearman\n')
cov(select(datos,starts_with("noise")),method = 'spearman')
cat('\nCorrelación Spearman\n')
cor(select(datos,starts_with("noise")),method = 'spearman')

GGally::ggpairs(select(datos,starts_with("noise")))
chart.Correlation(select(datos,starts_with("noise")))
```

```{r}
datos_tidy = datos %>% select(-year) %>% gather("noise", "value", 2:6) %>% separate(noise, into=c("noise_column", "noise"), sep="_") %>% select(-noise_column)
head(datos_tidy)
```

```{r}
library(grid)

multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                    ncol = cols, nrow = ceiling(numPlots/cols))
  }

 if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}
```

```{r}
gd1 = ggplot(datos_tidy, aes(noise, value, fill=noise))+geom_violin()+theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="none")
gd2 = ggplot(datos_tidy, aes(noise, value, color=noise))+geom_boxplot()+theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position="none")
multiplot(gd1, gd2, cols=2)

```


```{r}
ggplot(datos_tidy, aes(x = dateObserved, y = value, color = noise)) +
  geom_line() + facet_wrap(~Street)

```
```{r}
ggplot(datos_tidy, aes(x = dateObserved, y = value, color = noise)) +
  geom_point(size=0.5, shape=10)+geom_smooth(method=lm)
```
```{r}
ggplot(datos_tidy, aes(x = dateObserved, y = value, color = noise)) +
  geom_point(size=0.5, shape=10)+geom_smooth()+facet_wrap(~Street)
```
```{r}

ggplot(datos_tidy, aes(x=Street, y=value, fill=Street)) + 
    geom_boxplot() + theme(axis.text.x = element_text(angle = 45, hjust = 1))
```
```{r}
ggplot(data = datos_tidy, aes(x = dateObserved, y = value, color = noise)) +  
    guides(colour = guide_legend(override.aes = list(size=10))) +
    geom_smooth(alpha = 0.2, size = 0.5, span = 4, se=FALSE) + 
    theme(legend.key = element_rect(fill = "white"))+ facet_wrap(~Street)
```
    
Ideas de graficos:
- Histograma faceteado por tipo de ruido (tdr) especial atencion en que los breaks sean siempre los mismos
- Diagrama de densidad
- Grafico de lineas coloreado por tdr
- Añadir lineas en los puntos mas importantes y fechas relevantes
- Igual ver las posibilidades que nos ofrecen los graficos de dispersion, pero no se exactamente el qué
- Añadirle el smooth al sactter plot
- Igual puede servirnos el case_when para crear nuevas variables y agrupar segun valores
- Hacer graficos para ver correlaciones